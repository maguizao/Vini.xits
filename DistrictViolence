--// SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

--// STATES
local ESP = { Killer = false, Players = false, Generators = false }
local Hitbox = { Enabled = false, Size = 8 }
local AutoSkill = false

local Highlights = {}
local OriginalSizes = {}

--// HELPER: IS KILLER (Nova Lógica)
local function isKiller(player)
    if not player.Team then return false end
    -- Verifica se o nome do time contém "killer"
    return player.Team.Name:lower():find("killer") ~= nil
end

--// HIGHLIGHT
local function createHighlight(inst, color)
    if Highlights[inst] then return end
    local h = Instance.new("Highlight")
    h.Adornee = inst
    h.FillColor = color
    h.OutlineColor = Color3.new(1, 1, 1)
    h.FillTransparency = 0.35
    h.Parent = inst
    Highlights[inst] = h
end

local function removeHighlight(inst)
    if Highlights[inst] then
        Highlights[inst]:Destroy()
        Highlights[inst] = nil
    end
end

--// FIND GENERATORS
local function FindGenerators()
    local gens = {}
    local map = workspace:FindFirstChild("Map") or workspace:FindFirstChild("Map1")
    if not map then return gens end

    for _, obj in ipairs(map:GetDescendants()) do
        if obj:IsA("Model") and obj.Name == "Generator" then
            table.insert(gens, obj)
        end
    end
    return gens
end

--// ESP UPDATES
local function updateKillerESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            -- Usa a nova função de detecção por time
            if ESP.Killer and isKiller(plr) then
                createHighlight(plr.Character, Color3.fromRGB(255, 60, 60))
            elseif not ESP.Players then -- Só remove se o ESP de player comum também estiver off
                removeHighlight(plr.Character)
            end
        end
    end
end

local function updatePlayerESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            -- Se for player normal (não killer)
            if ESP.Players and not isKiller(plr) then
                createHighlight(plr.Character, Color3.fromRGB(0, 160, 255))
            elseif not (ESP.Killer and isKiller(plr)) then
                removeHighlight(plr.Character)
            end
        end
    end
end

local function updateGeneratorESP()
    for _, gen in ipairs(FindGenerators()) do
        if ESP.Generators then
            createHighlight(gen, Color3.fromRGB(0, 255, 120))
        else
            removeHighlight(gen)
        end
    end
end

--// HITBOX LOOP
task.spawn(function()
    while true do
        if Hitbox.Enabled then
            for _, plr in ipairs(Players:GetPlayers()) do
                if plr ~= LocalPlayer and plr.Character then
                    local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
                    -- Aumenta hitbox apenas de quem NÃO é killer
                    if hrp and not isKiller(plr) then
                        if not OriginalSizes[hrp] then
                            OriginalSizes[hrp] = hrp.Size
                        end
                        hrp.Size = Vector3.new(Hitbox.Size, Hitbox.Size, Hitbox.Size)
                        hrp.CanCollide = false
                    end
                end
            end
        else
            for hrp, size in pairs(OriginalSizes) do
                if hrp and hrp.Parent then
                    hrp.Size = size
                    hrp.CanCollide = true
                end
            end
            table.clear(OriginalSizes)
        end
        task.wait(0.5)
    end
end)

--// ESP LOOP
task.spawn(function()
    while true do
        updateKillerESP()
        updatePlayerESP()
        updateGeneratorESP()
        task.wait(1)
    end
end)

--// AUTO SKILLCHECK (Metatable Hook)
local mt = getrawmetatable(game)
setreadonly(mt, false)
local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
    local args = { ... }
    local method = getnamecallmethod()

    if AutoSkill and method == "FireServer" and tostring(self) == "SkillCheckResultEvent" then
        args[1] = "success"
        args[2] = 1
        return old(self, unpack(args))
    end

    return old(self, ...)
end)
setreadonly(mt, true)

--// GUI (COREGUI) - Mantive sua estrutura original
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ffthax_gui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = CoreGui

local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.fromScale(0, 0)
Main.Position = UDim2.fromScale(0.5, 0.5)
Main.AnchorPoint = Vector2.new(0.5, 0.5)
Main.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true
Main.ClipsDescendants = true
Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 8)

TweenService:Create(Main, TweenInfo.new(0.3, Enum.EasingStyle.Quint), {
    Size = UDim2.fromOffset(260, 170)
}):Play()

--// TOP BAR
local Top = Instance.new("Frame", Main)
Top.Size = UDim2.new(1, 0, 0, 28)
Top.BackgroundColor3 = Color3.fromRGB(15, 15, 15)

local Title = Instance.new("TextLabel", Top)
Title.Size = UDim2.new(1, 0, 1, 0)
Title.Text = "ffthax v0.3.5"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 11
Title.TextColor3 = Color3.fromRGB(255, 255, 0)
Title.BackgroundTransparency = 1

local Min = Instance.new("TextButton", Top)
Min.Size = UDim2.fromOffset(22, 22)
Min.Position = UDim2.new(1, -26, 0, 3)
Min.Text = "-"
Min.Font = Enum.Font.GothamBold
Min.TextSize = 14
Min.TextColor3 = Color3.new(1, 1, 1)
Min.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Instance.new("UICorner", Min).CornerRadius = UDim.new(1, 0)

local minimized = false
Min.MouseButton1Click:Connect(function()
    minimized = not minimized
    TweenService:Create(Main, TweenInfo.new(0.25), {
        Size = minimized and UDim2.fromOffset(260, 28) or UDim2.fromOffset(260, 170)
    }):Play()
end)

--// TABS ENGINE
local Tabs = Instance.new("Frame", Main)
Tabs.Position = UDim2.fromOffset(6, 34)
Tabs.Size = UDim2.fromOffset(70, 130)
Tabs.BackgroundTransparency = 1

local function TabButton(text, y)
    local b = Instance.new("TextButton", Tabs)
    b.Size = UDim2.fromOffset(70, 30)
    b.Position = UDim2.fromOffset(0, y)
    b.Text = text
    b.Font = Enum.Font.Gotham
    b.TextSize = 11
    b.TextColor3 = Color3.new(1, 1, 1)
    b.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
    return b
end

local Content = Instance.new("Frame", Main)
Content.Position = UDim2.fromOffset(82, 34)
Content.Size = UDim2.fromOffset(170, 130)
Content.BackgroundTransparency = 1

local function clear()
    for _, v in ipairs(Content:GetChildren()) do v:Destroy() end
end

local function Toggle(text, y, stateKey, callback)
    local b = Instance.new("TextButton", Content)
    b.Size = UDim2.fromOffset(170, 30)
    b.Position = UDim2.fromOffset(0, y)
    
    -- Inicializa o texto baseado no estado atual
    local current = false
    if type(stateKey) == "string" then current = ESP[stateKey] or Hitbox[stateKey] or AutoSkill end
    
    b.Text = text .. (current and " : ON" or " : OFF")
    b.Font = Enum.Font.Gotham
    b.TextSize = 10
    b.TextColor3 = Color3.new(1, 1, 1)
    b.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)

    b.MouseButton1Click:Connect(function()
        local newState = not (b.Text:find("ON") ~= nil)
        b.Text = text .. (newState and " : ON" or " : OFF")
        callback(newState)
    end)
end

--// PAGES
local function loadESP()
    clear()
    Toggle("ESP Killer", 0, "Killer", function(v) ESP.Killer = v end)
    Toggle("ESP Players", 36, "Players", function(v) ESP.Players = v end)
    Toggle("ESP Generators", 72, "Generators", function(v) ESP.Generators = v end)
end

local function loadTools()
    clear()
    Toggle("Hitbox Players", 0, "Enabled", function(v) Hitbox.Enabled = v end)
    Toggle("Auto SkillCheck", 36, "AutoSkill", function(v) AutoSkill = v end)

    local box = Instance.new("TextBox", Content)
    box.Size = UDim2.fromOffset(170, 26)
    box.Position = UDim2.fromOffset(0, 72)
    box.Text = tostring(Hitbox.Size)
    box.PlaceholderText = "Hitbox Size"
    box.Font = Enum.Font.Gotham
    box.TextSize = 10
    box.TextColor3 = Color3.new(1, 1, 1)
    box.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    box.ClearTextOnFocus = false
    Instance.new("UICorner", box).CornerRadius = UDim.new(0, 6)

    box.FocusLost:Connect(function()
        local v = tonumber(box.Text)
        if v and v >= 2 and v <= 30 then
            Hitbox.Size = v
        else
            box.Text = tostring(Hitbox.Size)
        end
    end)
end

local EspTab = TabButton("ESP", 0)
local ToolsTab = TabButton("Tools", 36)

EspTab.MouseButton1Click:Connect(loadESP)
ToolsTab.MouseButton1Click:Connect(loadTools)

loadESP()
